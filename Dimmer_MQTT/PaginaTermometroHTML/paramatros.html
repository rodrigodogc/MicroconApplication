<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Painel • Configuração & Controle</title>
<style>
  :root{
    --blue-900:#0a2540; --blue-800:#113a6b; --blue-700:#1a4d8f;
    --blue-600:#2a6fdb; --blue-500:#3b82f6; --blue-400:#60a5fa; --blue-300:#93c5fd;
    --ink-900:#0b1220; --ink-700:#1f2937; --ink-400:#9ca3af;
    --bg-grad: radial-gradient(1200px 900px at 20% -10%, rgba(59,130,246,.25), transparent 60%),
               radial-gradient(1200px 900px at 120% 10%, rgba(37,99,235,.30), transparent 60%),
               linear-gradient(180deg, #0b1220 0%, #0a2540 100%);
    --glass: rgba(255,255,255,.08);
    --success:#22c55e; --err:#ef4444;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  body{
    margin:0; font:15px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    color:#e8eefc; background:var(--bg-grad); min-height:100vh;
    display:flex; flex-direction:column;
  }
  /* Topbar */
  .topbar{
    position:sticky; top:0; z-index:50;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:12px 16px; backdrop-filter:saturate(140%) blur(10px);
    background:linear-gradient(180deg, rgba(10,37,64,.9), rgba(10,37,64,.55));
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .brand{display:flex; align-items:center; gap:10px; min-width:0}
  .logo{
    width:32px; height:32px; border-radius:10px;
    background:conic-gradient(from 220deg, var(--blue-300), var(--blue-600), var(--blue-400));
    display:grid; place-items:center; box-shadow:0 6px 22px rgba(59,130,246,.35) inset;
    flex:0 0 auto;
  }
  .logo svg{width:18px; height:18px; opacity:.92}
  .brand h1{margin:0; font-size:16px; font-weight:600; letter-spacing:.3px; color:#dbeafe; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .rightbar{display:flex; align-items:center; gap:10px; flex:0 0 auto;}
  .ghost,.btn{
    display:inline-flex; align-items:center; gap:8px; text-decoration:none;
    padding:10px 12px; border-radius:12px; font-weight:600; letter-spacing:.2px;
    border:1px solid rgba(255,255,255,.12); color:#dbeafe; background:rgba(59,130,246,.12);
    transition:.2s transform,.2s background,.2s border-color; cursor:pointer;
  }
  .ghost:hover,.btn:hover{transform:translateY(-1px); background:rgba(59,130,246,.16); border-color:rgba(255,255,255,.18)}
  .conn{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px; border-radius:999px; font-weight:600; color:#dceaff; font-size:13px;
    background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12);
  }
  .conn .dot{width:10px; height:10px; border-radius:50%; background:#94a3b8}
  .conn.online .dot{ background:var(--success); animation:pulse 1.6s infinite ease-in-out; }
  @keyframes pulse{
    0%,100%{ transform:scale(1); box-shadow:0 0 0 0 rgba(34,197,94,.45); }
    50%    { transform:scale(1.15); box-shadow:0 0 0 6px rgba(34,197,94,.05); }
  }
  .wrap{flex:1; display:grid; place-items:center; padding:20px}
  .card{
    width:min(920px, 96vw);
    background:var(--glass); border:1px solid rgba(255,255,255,.08);
    border-radius:20px; padding:18px; box-shadow:
      0 24px 80px rgba(3, 24, 66, .45),
      inset 0 1px 0 rgba(255,255,255,.06);
  }
  .grid{display:grid; gap:18px; grid-template-columns: 1.2fr 1fr}
  @media (max-width: 880px){ .grid{grid-template-columns:1fr} .wrap{padding:14px} .card{padding:14px} }
  .section{
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
    border-radius:16px; padding:14px;
  }
  .title{
    display:flex; align-items:center; justify-content:space-between;
    margin:0 0 10px; font-size:15px; color:#cfe4ff; font-weight:700; letter-spacing:.3px;
  }
  .temp{display:flex; align-items:baseline; gap:8px; margin-top:6px; color:#eaf2ff}
  .temp .v{font-size:36px; font-weight:800}
  .temp small{color:#b6c6e8}
  .hint{color:#9db7e7; font-size:12px; margin-top:8px}

  /* Knob */
  .knob-wrap{display:grid; place-items:center; padding:10px 0}
  .knob{
    --size: clamp(180px, 46vw, 260px);
    width:var(--size); height:var(--size); border-radius:50%;
    position:relative; display:grid; place-items:center;
    background:
      radial-gradient(closest-side, rgba(255,255,255,.08), rgba(255,255,255,.03) 60%, transparent 61%) padding-box,
      conic-gradient(#60a5fa calc(var(--pct,0)*1%), rgba(255,255,255,.10) 0) border-box;
    border: 10px solid transparent;
    box-shadow:
      inset 0 0 0 2px rgba(255,255,255,.08),
      0 30px 70px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.06);
    cursor:grab; user-select:none; touch-action:none;
  }
  .knob:active{cursor:grabbing}
  .ticks{position:absolute; inset:8px; border-radius:50%; pointer-events:none; opacity:.55}
  .dot{
    position:absolute; width:10px; height:10px; border-radius:50%;
    background:#fff; box-shadow:0 0 0 6px rgba(96,165,250,.18), 0 0 0 1px rgba(255,255,255,.8) inset;
    /* raio levemente menor p/ ficar no anel certo */
    transform: translate(-50%, -50%) rotate(var(--angle, -135deg)) translate(calc(var(--size)/2.45));
    top:50%; left:50%;
  }
  .knob-center{
    position:absolute; width:64%; height:64%; border-radius:50%;
    background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.12), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.08);
    display:grid; place-items:center; text-align:center; padding:8px;
  }
  .readout .big{
    font-size:34px; font-weight:800; color:#e8f1ff;
    font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1, "lnum" 1;
    line-height:1; letter-spacing:.5px;
    min-width:8ch; /* estabilidade visual para '100/100%' */
    text-align:center;
  }
  .readout .of{opacity:.7; margin-left:4px}
  .readout .mini{font-size:12px; color:#9cb6df}
  .pill{
    display:inline-flex; align-items:center; gap:8px; padding:7px 10px;
    background:rgba(59,130,246,.14); border:1px solid rgba(255,255,255,.12);
    border-radius:999px; color:#dceaff; font-weight:600; letter-spacing:.2px; font-size:13px;
  }
  .actions{display:flex; align-items:center; justify-content:space-between; margin-top:10px}
  .btn.secondary{background:rgba(255,255,255,.08); color:#dceaff; border-color:rgba(255,255,255,.12)}
  /* Toast único, embaixo */
  .status{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:14px; z-index:60; width: min(92vw, 520px);
    display:flex; justify-content:center; pointer-events:none;
  }
  .toast{
    background:rgba(10,37,64,.90); border:1px solid rgba(255,255,255,.10);
    color:#e6f0ff; border-radius:12px; padding:10px 12px; font-size:13px; letter-spacing:.2px;
    box-shadow:0 14px 40px rgba(0,0,0,.35);
    display:flex; align-items:center; gap:10px; max-width:100%; pointer-events:auto;
  }
  .toast.ok{border-color:rgba(34,197,94,.45)}
  .toast.err{border-color:rgba(239,68,68,.45)}
  /* Modal */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(3,8,20,.6); backdrop-filter:blur(4px);
    display:none; align-items:center; justify-content:center; z-index:80;
  }
  .modal{
    width:min(560px, 92vw); background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:14px;
    box-shadow:0 30px 70px rgba(0,0,0,.5);
  }
  .modal h3{margin:0 0 10px; font-size:18px; color:#e6f0ff}
  .fgrid{display:grid; gap:10px; grid-template-columns:1fr 1fr}
  .fgrid .full{grid-column:1/-1}
  .field{display:flex; flex-direction:column; gap:6px}
  .field label{font-size:12px; color:#b7c6e6}
  .field input{
    padding:12px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.08); color:#eaf2ff; outline:none; font-size:15px;
  }
  .modal-actions{display:flex; justify-content:flex-end; gap:10px; margin-top:10px}
  @media (max-width:520px){
    .readout .big{font-size:30px}
    .temp .v{font-size:32px}
    .ghost,.btn{padding:9px 10px; border-radius:10px}
  }
</style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2v6M12 16v6M4 12h6M14 12h6"/>
          <circle cx="12" cy="12" r="5"></circle>
        </svg>
      </div>
      <h1>Controle de Ventilador • ESP</h1>
    </div>
    <div class="rightbar">
      <div id="connTag" class="conn"><span class="dot"></span><span id="connText">Offline</span></div>
      <button id="btnConfig" class="ghost" title="Abrir configurações">Configurar</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="grid">
        <!-- Coluna potenciômetro -->
        <div class="section">
          <h2 class="title">Potenciômetro (Duty)</h2>
          <div class="knob-wrap">
            <div id="knob" class="knob" role="slider" aria-valuemin="0" aria-valuemax="255" aria-valuenow="0" tabindex="0">
              <div class="ticks"></div>
              <div class="dot"></div>
              <div class="knob-center">
                <div class="readout">
                  <div class="big"><span id="pctVal">0</span><span class="of">/100%</span></div>
                  <div class="mini">Arraste/Toque para ajustar</div>
                </div>
              </div>
            </div>
          </div>
          <div class="actions">
            <div class="pill">Duty atual: <strong id="pillDuty">0%</strong></div>
            <button id="btnFreq" class="btn" title="Definir frequência PWM">Frequência</button>
          </div>
          <div class="hint">Ao ajustar o potenciômetro, o valor é enviado imediatamente para <code>/set_dutycicle?dutycicle=</code>.</div>
        </div>

        <!-- Coluna Temperatura -->
        <div class="section">
          <h2 class="title">Temperatura Atual</h2>
          <div class="temp">
            <div class="v" id="tempVal">--.-</div>
            <small>°C</small>
          </div>
          <div class="hint">Consulta periódica a <code>/get_temperatura</code>.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast único -->
  <div class="status" id="status"></div>

  <!-- Modal Configurações (POST /configurar) -->
  <div class="modal-backdrop" id="modalConfig">
    <div class="modal">
      <h3>Configurações de Rede e MQTT</h3>
      <form id="formConfig">
        <div class="fgrid">
          <div class="field">
            <label>Wi-Fi (SSID)</label>
            <input id="f_wifi" required placeholder="Nome da rede" />
          </div>
          <div class="field">
            <label>Senha Wi-Fi</label>
            <input id="f_senha" type="password" placeholder="********" />
          </div>
          <div class="field">
            <label>IP do Broker</label>
            <input id="f_ip" required placeholder="192.168.0.10" />
          </div>
          <div class="field">
            <label>Usuário MQTT</label>
            <input id="f_user" placeholder="usuario (opcional)" />
          </div>
          <div class="field">
            <label>Senha MQTT</label>
            <input id="f_pass" type="password" placeholder="senha (opcional)" />
          </div>
          <div class="field full">
            <label>Local</label>
            <input id="f_local" placeholder="Ex.: Linha 1 - Ventilador A" />
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn" id="btnCloseConfig">Cancelar</button>
          <button type="submit" class="btn">Salvar & Enviar</button>
        </div>
      </form>
      <div class="hint">Ao enviar, este dispositivo irá reiniciar automaticamente.</div>
    </div>
  </div>

  <!-- Modal Frequência (/set_frequencia) -->
  <div class="modal-backdrop" id="modalFreq">
    <div class="modal">
      <h3>Definir frequência PWM</h3>
      <div class="fgrid">
        <div class="field full">
          <label>Frequência (1 a 20000 Hz)</label>
          <input id="f_freq" type="number" min="1" max="20000" value="1000" />
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="btnCloseFreq" type="button">Cancelar</button>
        <button class="btn" id="btnApplyFreq" type="button">Aplicar</button>
      </div>
      <div class="hint">A frequência é enviada para <code>/set_frequencia?frequencia=</code>.</div>
    </div>
  </div>

<script>
(function(){
  const knob = document.getElementById('knob');
  const pctVal  = document.getElementById('pctVal');
  const pillDuty = document.getElementById('pillDuty');
  const tempVal = document.getElementById('tempVal');
  const statusBox = document.getElementById('status');

  // Topbar connection tag
  const connTag = document.getElementById('connTag');
  const connText = document.getElementById('connText');

  // Config modal
  const btnConfig = document.getElementById('btnConfig');
  const modalConfig = document.getElementById('modalConfig');
  const btnCloseConfig = document.getElementById('btnCloseConfig');
  const formConfig = document.getElementById('formConfig');
  const fWifi = document.getElementById('f_wifi');
  const fSenha= document.getElementById('f_senha');
  const fIp   = document.getElementById('f_ip');
  const fUser = document.getElementById('f_user');
  const fPass = document.getElementById('f_pass');
  const fLocal= document.getElementById('f_local');

  // Freq modal
  const btnFreq = document.getElementById('btnFreq');
  const modalFreq = document.getElementById('modalFreq');
  const btnCloseFreq = document.getElementById('btnCloseFreq');
  const btnApplyFreq = document.getElementById('btnApplyFreq');
  const fFreq = document.getElementById('f_freq');

  // Estado
  let value = 0; // 0..255
  let dragging = false;
  let lastOkTs = 0;
  let lastToastTs = 0;

  const clamp = (n,min,max)=>Math.min(Math.max(n,min),max);
  const pctOf = v => Math.round((v/255)*100);

  function setVisual(v){
    value = clamp(v,0,255);
    const pct = pctOf(value);
    knob.style.setProperty('--pct', (value/255)*100);
    const angle = -135 + (270 * (value/255)); // var(--angle) em graus
    knob.style.setProperty('--angle', angle+'deg');
    knob.setAttribute('aria-valuenow', value);
    pctVal.textContent = String(pct);
    pillDuty.textContent = pct + '%';
  }

  // Toast único
  function toast(msg, kind='ok'){
    statusBox.innerHTML = '';
    const el = document.createElement('div');
    el.className = 'toast '+(kind==='ok'?'ok':'err');
    el.textContent = msg;
    statusBox.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(4px)'; }, 1800);
    setTimeout(()=>{ el.remove(); }, 2300);
  }

  // Conexão visual na barra
  function updateConnVisual(){
    const online = (Date.now() - lastOkTs) < 5000;
    connTag.classList.toggle('online', online);
    connText.textContent = online ? 'Conectado' : 'Offline';
  }
  setInterval(updateConnVisual, 1000);

  // GET /set_dutycicle imediato
  let lastAbort = null;
  async function sendDuty(v){
    try{
      if (lastAbort) lastAbort.abort();
      lastAbort = new AbortController();
      const r = await fetch(`/set_dutycicle?dutycicle=${v}`, {signal:lastAbort.signal});
      if(!r.ok) throw new Error('HTTP '+r.status);
      lastOkTs = Date.now();
      updateConnVisual();
      if (Date.now() - lastToastTs > 650){
        toast('Duty atualizado para '+pctOf(v)+'%', 'ok');
        lastToastTs = Date.now();
      }
    }catch(e){
      if (e.name === 'AbortError') return;
      toast('Falha ao atualizar duty', 'err');
    }
  }

  // Ângulo correto a partir do topo (0° no topo, sentido horário positivo)
  function pointToValue(clientX, clientY){
    const rect = knob.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2;
    const dx = clientX - cx;
    const dy = clientY - cy;
    // Ângulo em graus com 0° no topo, horário positivo:
    let angTopClock = Math.atan2(dx, -dy) * 180/Math.PI; // [-180,180], 0 no topo
    // Limita ao arco de -135° a +135°
    let a = clamp(angTopClock, -135, 135);
    const t = (a + 135) / 270; // 0..1
    return Math.round(t * 255);
  }

  function handlePointer(e){
    const v = pointToValue(e.clientX, e.clientY);
    setVisual(v);
    sendDuty(v);
  }

  // Eventos de ponteiro/touch
  knob.addEventListener('pointerdown', (e)=>{ dragging = true; knob.setPointerCapture(e.pointerId); handlePointer(e); });
  knob.addEventListener('pointermove', (e)=>{ if(dragging) handlePointer(e); });
  knob.addEventListener('pointerup',   (e)=>{ dragging = false; try{knob.releasePointerCapture(e.pointerId);}catch(_){}});

  // Teclado
  knob.addEventListener('keydown', (e)=>{
    let step = (e.shiftKey? 15 : 5);
    if (e.key === 'ArrowRight' || e.key === 'ArrowUp'){ setVisual(value+step); sendDuty(value); }
    if (e.key === 'ArrowLeft'  || e.key === 'ArrowDown'){ setVisual(value-step); sendDuty(value); }
  });

  // Inicial
  setVisual(0);

  // Temperatura periódica
  async function refreshTemp(){
    try{
      const r = await fetch('/get_temperatura');
      if(!r.ok) throw new Error();
      const j = await r.json();
      const t = parseFloat(j.temp);
      if (!isNaN(t)) tempVal.textContent = t.toFixed(1);
      lastOkTs = Date.now();
      updateConnVisual();
    }catch(_){
      // mantém estado offline se demorar >5s
    }
  }
  refreshTemp();
  setInterval(refreshTemp, 2000);

  // ----- Modais -----
  function openModal(el){ el.style.display='flex'; }
  function closeModal(el){ el.style.display='none'; }

  // Botão Configurar abre modal
  btnConfig.addEventListener('click', ()=> openModal(modalConfig));
  btnCloseConfig.addEventListener('click', ()=> closeModal(modalConfig));
  modalConfig.addEventListener('click', (e)=>{ if(e.target===modalConfig) closeModal(modalConfig); });

  // Pré-carrega configs (se houver) com /recuperarConfigs
  async function preloadConfigs(){
    try{
      const r = await fetch('/recuperarConfigs');
      if(!r.ok) return;
      const txt = await r.text();
      const parts = txt.split(',');
      if (parts.length>=6){
        fWifi.value  = parts[0]||'';
        fSenha.value = parts[1]||'';
        fIp.value    = parts[2]||'';
        fUser.value  = parts[3]||'';
        fPass.value  = parts[4]||'';
        fLocal.value = parts[5]||'';
      }
    }catch(_){}
  }
  preloadConfigs();

  // Envia POST /configurar com CSV no corpo
  formConfig.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = [
      fWifi.value.trim(),
      fSenha.value.trim(),
      fIp.value.trim(),
      fUser.value.trim(),
      fPass.value.trim(),
      fLocal.value.trim()
    ].join(',');
    try{
      const r = await fetch('/configurar', {
        method:'POST',
        headers:{'Content-Type':'text/plain'},
        body: payload
      });
      if(!r.ok) throw new Error();
      toast('Configurações enviadas. O dispositivo irá reiniciar…','ok');
      setTimeout(()=>{ closeModal(modalConfig); }, 800);
    }catch(_){
      toast('Falha ao enviar configurações','err');
    }
  });

  // Frequência (popup)
  btnFreq.addEventListener('click', ()=> openModal(modalFreq));
  btnCloseFreq.addEventListener('click', ()=> closeModal(modalFreq));
  modalFreq.addEventListener('click', (e)=>{ if(e.target===modalFreq) closeModal(modalFreq); });

  btnApplyFreq.addEventListener('click', async ()=>{
    const v = clamp(parseInt(fFreq.value||'1000',10),1,20000);
    try{
      const r = await fetch(`/set_frequencia?frequencia=${v}`);
      if(!r.ok) throw new Error();
      toast('Frequência atualizada para '+v+' Hz','ok');
      closeModal(modalFreq);
      lastOkTs = Date.now();
      updateConnVisual();
    }catch(_){
      toast('Erro ao atualizar frequência','err');
    }
  });

})();
</script>
</body>
</html>